name: Build APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install JS dependencies
        run: npm install

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses || true

      # ── Tạo các file Android còn thiếu ──────────────────────────────
      - name: Create android/build.gradle
        run: |
          cat > android/build.gradle << 'GRADLE'
          buildscript {
            ext {
              buildToolsVersion = "34.0.0"
              minSdkVersion = 23
              compileSdkVersion = 34
              targetSdkVersion = 34
            }
            repositories { google(); mavenCentral() }
            dependencies {
              classpath("com.android.tools.build:gradle:8.2.2")
              classpath("com.facebook.react:react-native-gradle-plugin")
            }
          }
          GRADLE

      - name: Create android/gradle.properties
        run: |
          cat > android/gradle.properties << 'PROPS'
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m
          android.useAndroidX=true
          android.enableJetifier=false
          PROPS

      - name: Create android/gradle/wrapper/gradle-wrapper.properties
        run: |
          mkdir -p android/gradle/wrapper
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'WRAP'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.8-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          WRAP

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Create res folders and drawables
        run: |
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/drawable

          # ic_notification drawable (vector XML - không cần PNG)
          cat > android/app/src/main/res/drawable/ic_notification.xml << 'XML'
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="24dp" android:height="24dp" android:viewportWidth="24" android:viewportHeight="24">
            <path android:fillColor="#FFFFFF"
              android:pathData="M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10 10,-4.48 10,-10S17.52,2 12,2zm1,15h-2v-2h2v2zm0,-4h-2V7h2v6z"/>
          </vector>
          XML

          # Icons đã có sẵn trong repo (được bundle từ file gốc)

          # strings.xml
          cat > android/app/src/main/res/values/strings.xml << 'XML'
          <resources><string name="app_name">MedPro</string></resources>
          XML

          # styles.xml
          cat > android/app/src/main/res/values/styles.xml << 'XML'
          <resources>
            <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
              <item name="android:editTextBackground">@android:color/transparent</item>
            </style>
          </resources>
          XML

      - name: Create MainApplication and MainActivity Java files
        run: |
          mkdir -p android/app/src/main/java/com/medpro

          cat > android/app/src/main/java/com/medpro/MainApplication.java << 'JAVA'
          package com.medpro;
          import android.app.Application;
          import com.facebook.react.PackageList;
          import com.facebook.react.ReactApplication;
          import com.facebook.react.ReactNativeHost;
          import com.facebook.react.ReactPackage;
          import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
          import com.facebook.react.defaults.DefaultReactNativeHost;
          import com.facebook.soloader.SoLoader;
          import java.util.List;

          public class MainApplication extends Application implements ReactApplication {
            private final ReactNativeHost mReactNativeHost = new DefaultReactNativeHost(this) {
              @Override public boolean getUseDeveloperSupport() { return BuildConfig.DEBUG; }
              @Override public List<ReactPackage> getPackages() { return new PackageList(this).getPackages(); }
              @Override public String getJSMainModuleName() { return "index"; }
              @Override protected Boolean isNewArchEnabled() { return false; }
              @Override protected Boolean isHermesEnabled() { return true; }
            };
            @Override public ReactNativeHost getReactNativeHost() { return mReactNativeHost; }
            @Override public void onCreate() {
              super.onCreate();
              SoLoader.init(this, false);
            }
          }
          JAVA

          cat > android/app/src/main/java/com/medpro/MainActivity.java << 'JAVA'
          package com.medpro;
          import com.facebook.react.ReactActivity;
          import com.facebook.react.ReactActivityDelegate;
          import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
          import com.facebook.react.defaults.DefaultReactActivityDelegate;

          public class MainActivity extends ReactActivity {
            @Override protected String getMainComponentName() { return "MedPro"; }
            @Override protected ReactActivityDelegate createReactActivityDelegate() {
              return new DefaultReactActivityDelegate(this, getMainComponentName(), false);
            }
          }
          JAVA

      - name: Generate Keystore
        run: |
          cd android/app
          keytool -genkey -v \
            -keystore medpro-release.keystore \
            -alias medpro \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass medpro123 -keypass medpro123 \
            -dname "CN=MedPro,OU=Mobile,O=MedPro,L=HN,ST=HN,C=VN"
          touch proguard-rules.pro
          echo "" >> ../gradle.properties
          echo "MYAPP_RELEASE_STORE_FILE=medpro-release.keystore" >> ../gradle.properties
          echo "MYAPP_RELEASE_KEY_ALIAS=medpro" >> ../gradle.properties
          echo "MYAPP_RELEASE_STORE_PASSWORD=medpro123" >> ../gradle.properties
          echo "MYAPP_RELEASE_KEY_PASSWORD=medpro123" >> ../gradle.properties

      - name: Bundle JS (Metro)
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          JAVA_OPTS: "-Xmx4g"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MedPro-APK
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30
